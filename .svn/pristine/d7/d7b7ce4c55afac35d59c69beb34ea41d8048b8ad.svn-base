{"version":3,"sources":["MallController.js"],"names":["mallData_Purchase","cc","Class","name","properties","curTreasureAmount","isAutoRedeem","mallData_Redeem","curVoucherPointAmount","treasurePerPoint","gameFlags","require","mallFlags","extends","Component","_gameControl","default","type","visible","_mallModel","_mallView","mallPanel_PurchaseBlock","Node","mallPanel_RedeemBlock","isPurchaseConfirming","scrollView","ScrollView","voucherItem","Prefab","voucherItemArray","chosenIndex","onLoad","NOTIFICATION","on","MALL_CHOOSE_VOUCHER","onChooseVoucher","MALL_2_GAME","onMallToGame","variablesInit","start","init_PurchaseVoucherPanel","onDisable","off","GAME_2_MALL","onGameToMall","event","controllerDataUpdate","voucherPoint","enterRedeemBlock","enterPurchaseBlock","console","log","active","init_PurchaseBlock","init_RedeemBlock","onSwitchMallBlock","curVoucherPoint","activateLackOfVoucherPanel","redeemVoucherPoint","voucherPoint_Purchased","getVoucherValues","voucherAmount","updateVoucherPointOnController","redeemTreasure","increment","redeem_Treasure","curTreasure","newTreasure","emit","USER_RECHARGE_TREASURE_ADD","redeemVIP","deductRMB","index","redeem_vipDays","price_rmb","js","formatStr","activateConfirmPanel","onConfirmPurchasing","toggle_AutoRedeem_Purchase","isChecked","deactivateConfirmPanel","resetPurchase","onConfrimRedeem","inc_Treasure","redeemVoucherAmount","dec_VoucherPoint","updateTreasureOnController","onCanclePurchasing","onSliderEvent","sender","eventType","curRedeemAmount","Math","floor","progress","updateRedeemVoucherAmount","updateRedeemAmount","onExit","length","content","voucherValuesArray","i","item","instantiate","addChild","push","getComponent","setVoucherValues"],"mappings":"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","file":"MallController.js","sourceRoot":"..\\..\\..\\..\\..\\..\\assets\\scripts\\FireDragon\\Mall","sourcesContent":["//#region custom structs\r\nvar mallData_Purchase = cc.Class({\r\n    name: 'mall_DataSet',\r\n    properties: {\r\n        curTreasureAmount: 0,\r\n        isAutoRedeem: false\r\n    }\r\n});\r\n\r\nvar mallData_Redeem = cc.Class({\r\n    name: 'mallData_Redeem',\r\n    properties: {\r\n        curTreasureAmount: 0,\r\n        curVoucherPointAmount: 0,\r\n        treasurePerPoint: 0,\r\n    }\r\n});\r\n//#endregion\r\n\r\nvar gameFlags = require(\"GameFlags\");\r\nvar mallFlags = require(\"MallFlags\");\r\n\r\ncc.Class({\r\n    extends: cc.Component,\r\n\r\n//#region   PROPERTIES\r\n    properties: () => ({\r\n//  MVC\r\n        _gameControl: {\r\n            default: null,\r\n            type: require(\"GameController\"),\r\n            visible: true\r\n        },\r\n\r\n        _mallModel: {\r\n            default: null,\r\n            type: require(\"MallModel\"),\r\n            visible: true\r\n        },\r\n\r\n        _mallView: {\r\n            default: null,\r\n            type: require(\"MallView\"),\r\n            visible: true\r\n        },\r\n\r\n//  Interface nodes\r\n        mallPanel_PurchaseBlock: {\r\n            default: null,\r\n            type: cc.Node\r\n        },\r\n\r\n        mallPanel_RedeemBlock: {\r\n            default: null,\r\n            type: cc.Node\r\n        },\r\n//  custum structs\r\n        mallData_Purchase: {\r\n            default: {},\r\n            type: mallData_Purchase,\r\n            visible: false\r\n        },\r\n\r\n//  Flags\r\n        isPurchaseConfirming: {\r\n            default: false,\r\n            visible: false\r\n        },\r\n\r\n//  Voucher panel \r\n        scrollView: {\r\n            default: null,\r\n            type:cc.ScrollView\r\n        },\r\n        \r\n        voucherItem: {\r\n            default: null,\r\n            type: cc.Prefab\r\n        },\r\n\r\n        voucherItemArray: {\r\n            default: [],\r\n            type: [require(\"VoucherManager\")],\r\n            visible: false\r\n        },\r\n\r\n        chosenIndex: {\r\n            default: 0,\r\n            visible: false\r\n        },\r\n    }),\r\n//#endregion\r\n\r\n//#region life cycle\r\n    onLoad: function() {\r\n        NOTIFICATION.on(mallFlags.MALL_CHOOSE_VOUCHER, this.onChooseVoucher, this);\r\n        NOTIFICATION.on(mallFlags.MALL_2_GAME, this.onMallToGame, this);\r\n\r\n        this.variablesInit();\r\n    },\r\n\r\n    start: function() {\r\n        this.init_PurchaseVoucherPanel();        \r\n    },\r\n\r\n    onDisable: function() {\r\n        NOTIFICATION.off(mallFlags.MALL_CHOOSE_VOUCHER, this.onChooseVoucher, this);\r\n        NOTIFICATION.off(gameFlags.GAME_2_MALL, this.onGameToMall, this);        \r\n    },\r\n//#endregion\r\n\r\n//#region interfaces switching\r\n    onGameToMall: function(event) {\r\n        this.controllerDataUpdate();\r\n        \r\n        if (event.voucherPoint > 0) {\r\n            this.enterRedeemBlock();\r\n        } else if (event.voucherPoint === 0) {\r\n            this.enterPurchaseBlock();\r\n        } else {\r\n            console.log(\"illegal voucher point!\");\r\n            return;\r\n        }\r\n    },\r\n\r\n    enterPurchaseBlock: function() {\r\n        this.controllerDataUpdate();\r\n        this.mallPanel_PurchaseBlock.active = true;\r\n        this.mallPanel_RedeemBlock.active = false;\r\n        this._mallView.init_PurchaseBlock(this.mallData_Purchase);\r\n    },\r\n    \r\n    enterRedeemBlock: function() {\r\n        this.controllerDataUpdate();\r\n        this.mallPanel_RedeemBlock.active = true;\r\n        this.mallPanel_PurchaseBlock.active = false;\r\n        this._mallModel.init_RedeemBlock(this.mallData_Redeem);\r\n        this._mallView.init_RedeemBlock(this.mallData_Redeem);\r\n    },\r\n\r\n    //  hit close btn in top right corner, go back to GamePlay panel\r\n    onMallToGame: function() {\r\n        this.mallPanel_PurchaseBlock.active = false;\r\n        this.mallPanel_RedeemBlock.active = false;\r\n        this._gameControl.onMallToGame();\r\n    },\r\n\r\n    //  purchaseBlock <-> redeemBlock\r\n    onSwitchMallBlock: function() {\r\n        if (this.mallPanel_PurchaseBlock.active) {\r\n            if (this._gameControl.curVoucherPoint <= 0) {\r\n                this._mallView.activateLackOfVoucherPanel();\r\n                return;\r\n            }\r\n            this.enterRedeemBlock();\r\n        } else if (this.mallPanel_RedeemBlock.active) {\r\n            this.enterPurchaseBlock();\r\n        }\r\n    },\r\n//#endregion\r\n\r\n//#region   confirm purchasing in purchase block\r\n    //  when isAutoRedeem is unchecked, just add voucher point rather than current treasure\r\n    redeemVoucherPoint: function() {\r\n        let voucherPoint_Purchased = this.voucherItemArray[this.chosenIndex].getVoucherValues().voucherAmount;\r\n        this.mallData_Redeem.curVoucherPointAmount += voucherPoint_Purchased;\r\n\r\n        this._gameControl.updateVoucherPointOnController(this.mallData_Redeem.curVoucherPointAmount);\r\n        console.log(this.mallData_Redeem.curVoucherPointAmount);\r\n    },\r\n\r\n    //  when isAutoRedeem is checked, all the voucherPoint that been purchased will transformed to treasure automatically,\r\n    //  which means you can jump over the redemmVoucherPoint() to redemmTreasure() straight forward\r\n    redeemTreasure: function() {\r\n        let increment = this.voucherItemArray[this.chosenIndex].getVoucherValues().redeem_Treasure;\r\n        let curTreasure = this._gameControl.curTreasure;\r\n        let newTreasure = curTreasure + increment * 10000;\r\n\r\n        this.mallData_Purchase.curTreasureAmount += increment * 10000;\r\n        this._mallView.init_PurchaseBlock(this.mallData_Purchase);\r\n\r\n        //  call GameController to update the treasure amount which belongs to GameModel \r\n        NOTIFICATION.emit(gameFlags.USER_RECHARGE_TREASURE_ADD, {increment: increment * 10000});\r\n    },\r\n    \r\n    //  TODO\r\n    redeemVIP: function() {\r\n        \r\n    },\r\n    \r\n    //  TODO\r\n    deductRMB: function() {\r\n\r\n    },\r\n//#endregion\r\n\r\n//#region ui events\r\n    onChooseVoucher: function(event) {\r\n        if (this.isPurchaseConfirming === true) {\r\n            return;\r\n        }\r\n        this.isPurchaseConfirming = true;\r\n\r\n        this.chosenIndex = event.index;\r\n        let voucherAmount = this.voucherItemArray[this.chosenIndex].getVoucherValues().voucherAmount;\r\n        let redeem_Treasure = this.voucherItemArray[this.chosenIndex].getVoucherValues().redeem_Treasure;\r\n        let redeem_vipDays = this.voucherItemArray[this.chosenIndex].getVoucherValues().redeem_vipDays;\r\n        let price_rmb = this.voucherItemArray[this.chosenIndex].getVoucherValues().price_rmb;\r\n\r\n        console.log(cc.js.formatStr(\r\n            \"index: %s, voucherAmount: %s, treasure: %s, vip: %s days, price: %s rmb\",\r\n                this.chosenIndex, voucherAmount, redeem_Treasure, redeem_vipDays, price_rmb));\r\n\r\n        this._mallView.activateConfirmPanel();\r\n    },\r\n\r\n    //  call back on hit confirm button\r\n    onConfirmPurchasing: function() {\r\n        if (this.isPurchaseConfirming === false) {\r\n            return;\r\n        }\r\n\r\n        if (this._mallView.toggle_AutoRedeem_Purchase.isChecked) {\r\n            console.log(\"autoRedeem\");\r\n            this.redeemTreasure();  //  redeem treasure\r\n        } else {\r\n            this.redeemVoucherPoint();  //  redeem voucher point            \r\n        }\r\n        \r\n        this.redeemVIP();   //  redeem vip\r\n        this.deductRMB();   //  deduct rmb\r\n\r\n        this._mallView.deactivateConfirmPanel();\r\n        this.resetPurchase();\r\n    },\r\n\r\n    //  call back on hit redeem confirm button\r\n    onConfrimRedeem: function(){\r\n        let curTreasure = this._gameControl.curTreasure;\r\n        let inc_Treasure = this._mallModel.redeemVoucherAmount * this._gameControl.treasurePerPoint;\r\n\r\n        let curVoucherPoint = this._gameControl.curVoucherPoint;\r\n        let dec_VoucherPoint = this._mallModel.redeemVoucherAmount;\r\n\r\n        this.mallData_Redeem.curTreasureAmount = curTreasure + inc_Treasure;\r\n        this.mallData_Redeem.curVoucherPointAmount = curVoucherPoint - dec_VoucherPoint;\r\n        this._mallView.init_RedeemBlock(this.mallData_Redeem);\r\n        \r\n        this._gameControl.updateTreasureOnController(this.mallData_Redeem.curTreasureAmount);\r\n        this._gameControl.updateVoucherPointOnController(this.mallData_Redeem.curVoucherPointAmount);\r\n    },\r\n\r\n    //  on hit cancle purchase button\r\n    onCanclePurchasing: function() {\r\n        this.resetPurchase();\r\n        this._mallView.deactivateConfirmPanel();        \r\n    },\r\n\r\n    //  on sliding\r\n    onSliderEvent(sender, eventType) {\r\n        let curRedeemAmount = Math.floor(this.mallData_Redeem.curVoucherPointAmount * sender.progress);\r\n        if (curRedeemAmount <= 0) {\r\n            curRedeemAmount = 1;\r\n        }\r\n        this._mallModel.updateRedeemVoucherAmount(curRedeemAmount);\r\n        this._mallView.updateRedeemAmount(curRedeemAmount);\r\n    },\r\n\r\n    //  on hit exit button\r\n    onExit: function() {\r\n        NOTIFICATION.emit(mallFlags.MALL_2_GAME);\r\n    },\r\n//#endregion\r\n\r\n//#region  others\r\n    //  init the custom structs to prevent from undefined\r\n    variablesInit: function() {\r\n        this.mallData_Purchase = {curTreasureAmount: '0', isAutoRedeem: false};\r\n        this.mallData_Redeem = {curTreasureAmount: '0', curVoucherPointAmount: '0', treasurePerPoint: '0'}\r\n    },\r\n\r\n    //  update values of 2 custom structs, which will be sent to purchase block and redeem block\r\n    controllerDataUpdate: function() {\r\n        this.mallData_Purchase.curTreasureAmount = this._gameControl.curTreasure;\r\n        this.mallData_Purchase.isAutoRedeem = this._mallModel.isAutoRedeem;\r\n\r\n        this.mallData_Redeem.curTreasureAmount = this._gameControl.curTreasure;\r\n        this.mallData_Redeem.curVoucherPointAmount = this._gameControl.curVoucherPoint;\r\n        this.mallData_Redeem.treasurePerPoint = this._gameControl.treasurePerPoint;\r\n    },\r\n\r\n    //  init the scroll view, which is the containter of all voucher items\r\n    init_PurchaseVoucherPanel: function() {\r\n        if (this.voucherItemArray.length > 0) {\r\n            console.log(\"voucherContent has already been inited\");\r\n            return;\r\n        }\r\n\r\n        this.content = this.scrollView.content;\r\n        this.voucherValuesArray = this._mallModel.voucherValuesArray;\r\n\r\n        //  spawn all the vouchers\r\n        for (let i = 0; i < this._mallModel.voucherValuesArray.length; i++) {\r\n            let item = cc.instantiate(this.voucherItem);\r\n            this.content.addChild(item);\r\n            this.voucherItemArray.push(item.getComponent(\"VoucherManager\"));\r\n        }\r\n        \r\n        //  set vouchers' values\r\n        for (let i = 0; i < this.voucherItemArray.length; i++) {\r\n            this.voucherItemArray[i].setVoucherValues(i, this.voucherValuesArray[i]);\r\n        }\r\n    },\r\n\r\n    //  reset purchase after a purchasing operation(confirmed or cancled)\r\n    resetPurchase: function() {\r\n        this.isPurchaseConfirming = false;\r\n        this.chosenIndex = 0;\r\n    },\r\n//#endregion\r\n});\r\n"]}